<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>LCDR New Analytics Dashboard</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary-color: #007BFF;
            --secondary-color: #28A745;
            --danger-color: #DC3545;
            --warning-color: #FFC107;
            --ok-color: #28A745;
            --ndf-color: #FFC107;
            --scrap-color: #DC3545;
            --bg-light: #F8F9FA;
            --bg-dark: #343A40;
            --text-light: #F8F9FA;
            --text-dark: #212529;
        }

        /* Og√≥lny Reset i Cia≈Ço */
        html, body { 
            margin: 0; 
            padding: 0; 
            min-height: 100vh;
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            transition: all 0.3s;
        }
        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-light);
        }

        /* Kontener i Nag≈Ç√≥wek */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 3px solid var(--primary-color);
            margin-bottom: 25px;
        }
        header h1 {
            font-size: 2.5rem;
            margin: 0;
            font-weight: 700;
            color: var(--primary-color);
        }
        header h1 i {
            margin-right: 10px;
        }
        #current-date-info {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Kontrolki */
        .controls-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .controls-panel button, .controls-panel input, .controls-panel a {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #ccc;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            background-color: #fff;
            color: var(--text-dark);
        }
        .controls-panel button:hover, .controls-panel a:hover {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        .controls-panel button.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        .controls-panel input[type="date"], .controls-panel input[type="text"] {
            width: 180px;
            background-color: #fff;
        }
        .dark-mode .controls-panel button, .dark-mode .controls-panel input, .dark-mode .controls-panel a {
            background-color: var(--bg-dark);
            color: var(--text-light);
            border-color: #6c757d;
        }
        .dark-mode .controls-panel button:hover, .dark-mode .controls-panel a:hover {
            background-color: var(--primary-color);
        }

        /* Sekcje tabel */
        .dashboard-section {
            margin-bottom: 40px;
        }
        .dashboard-section h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            border-left: 5px solid var(--primary-color);
            padding-left: 10px;
            font-weight: 600;
        }

        /* Tabela Og√≥lna (Summary) */
        .summary-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff;
        }
        .dark-mode .summary-table {
            background-color: #495057;
        }
        .summary-table th, .summary-table td {
            padding: 12px 15px;
            text-align: center;
            border: none;
            border-bottom: 1px solid #dee2e6;
        }
        .dark-mode .summary-table th, .dark-mode .summary-table td {
            border-bottom: 1px solid #6c757d;
        }

        .summary-table th {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: 700;
            text-transform: uppercase;
        }
        .summary-table tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .dark-mode .summary-table tbody tr:nth-child(even) {
            background-color: #3e444a;
        }
        .summary-table tbody tr:hover {
            background-color: #e9ecef;
        }
        .dark-mode .summary-table tbody tr:hover {
            background-color: #5a6268;
        }
        
        /* Kolumny status√≥w w podsumowaniu */
        .summary-table td.ok { background-color: var(--ok-color); color: #fff; font-weight: bold; }
        .summary-table td.ndf { background-color: var(--warning-color); color: var(--text-dark); font-weight: bold; }
        .summary-table td.scrap-ttl { background-color: var(--danger-color); color: #fff; font-weight: bold; }

        /* Wiersz SUMA DZIENNA */
        .summary-table tr.total-row td {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-weight: 800;
            font-size: 1.2rem;
            border-top: 3px solid var(--primary-color);
        }
        .dark-mode .summary-table tr.total-row td {
            background-color: #212529;
        }
        .summary-table tr.total-row td:first-child {
            text-align: left;
        }

        /* Tabela Detali */
        .data-table th, .data-table td {
            text-align: left;
        }
        .data-table td:nth-child(1), .data-table td:nth-child(2) {
            text-align: center;
        }
        .data-table td i {
            margin-right: 5px;
        }
        
        /* Loader */
        .loader-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; color: #fff; font-size: 1.5rem;
        }
        .loader {
            border: 6px solid #f3f3f3; border-top: 6px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Prze≈ÇƒÖcznik Motywu */
        .theme-switch-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>

<div class="theme-switch-container">
    <button id="themeToggle" onclick="toggleTheme()">
        <i class="fas fa-moon"></i> Ciemny Tryb
    </button>
</div>

<div class="loader-overlay" id="loader" style="display:none;">
    <div class="loader"></div>
    <div>≈Åadowanie danych...</div>
</div>

<div class="container">
    <header>
        <h1><i class="fas fa-chart-line"></i> LCDR Analytics Dashboard</h1>
        <div id="current-date-info">Data: <span id="summary-date">≈Åadowanie...</span></div>
    </header>

    <div class="controls-panel">
        <button id="btn-today" data-type="today" onclick="setDate('today')"><i class="fas fa-calendar-day"></i> Dzisiaj</button>
        <button id="btn-yesterday" data-type="yesterday" onclick="setDate('yesterday')"><i class="fas fa-calendar-minus"></i> Wczoraj</button>
        
        <input type="date" id="date-picker-input" onchange="setDate('custom')" title="Wybierz datƒô">

        <input
            type="text"
            id="serial-filter"
            placeholder="üîé Szukaj SN lub Nazwy..."
            oninput="filterData(this.value)"
            title="Wyszukaj po numerze seryjnym lub nazwisku"
        />

        <button onclick="manualLoad()"><i class="fas fa-sync-alt"></i> ≈ÅADUJ DANE</button>
        <button onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Eksportuj do Excela</button>
        <a href="https://r3f1.github.io/OLED-REPAIR/" target="_blank" style="background-color: #6C757D; color: #fff;"><i class="fas fa-tv"></i> OLED LIVE DATA</a>
    </div>

    <div class="dashboard-section">
        <h2><i class="fas fa-table"></i> Podsumowanie Napraw</h2>
        <table class="summary-table" id="summary-table">
            <thead>
                <tr>
                    <th>NAPRAWIACZ</th>
                    <th class="ok">OK</th>
                    <th class="ndf">NDF</th>
                    <th class="scrap-ttl">SCRAP TTL</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="dashboard-section">
        <h2><i class="fas fa-list"></i> Szczeg√≥≈Çy Transakcji</h2>
        <table class="summary-table data-table" id="data-table">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Station</th>
                    <th>Serial Number</th>
                    <th>Name</th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="no-data-message" style="text-align:center; padding:20px; font-weight:bold; font-size:1.2rem; display:none;">Brak danych do wy≈õwietlenia.</div>
    </div>
</div>

<script>
    // **********************************************
    // LOGIKA POBIERANIA DANYCH Z GOOGLE SHEETS (PRZEJƒòTA BEZ ZMIAN)
    // **********************************************
    const urls = [
        'https://docs.google.com/spreadsheets/d/10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU/export?format=csv&gid=0',
        'https://docs.google.com/spreadsheets/d/10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU/export?format=csv&gid=193025884',
        'https://docs.google.com/spreadsheets/d/10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU/export?format=csv&gid=661466938'
    ];

    let latestData = [];
    let currentDate = new Date();
    const datePicker = document.getElementById('date-picker-input');
    const loader = document.getElementById('loader');

    function parseCSV(text) {
        return text.trim().split('\n').map(row =>
            row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)
                ?.map(cell => cell.replace(/^"|"$/g,'').trim()) || []
        );
    }
    
    function normalizeDate(s) {
        if (!s) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
            const [d,m,y] = s.split('/');
            return `${y}-${m}-${d}`;
        }
        return '';
    }
    
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    function setDatePickerValue(date) {
        if (datePicker) {
            datePicker.value = formatDate(date);
        }
    }

    function highlightActive(type) {
        document.querySelectorAll('.controls-panel button').forEach(btn => {
            if (btn.dataset.type) {
                btn.classList.toggle('active', btn.dataset.type === type);
            }
        });
    }

    async function loadData() {
        const tgt = formatDate(currentDate);
        const all = [];
        const stationNames = ["KOVALCHYK", "ULANOVYCH", "OLED REPAIR"];

        for (let idx = 0; idx < urls.length; idx++) {
            const url = urls[idx];
            let stationName = stationNames[idx];
            
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const text = await res.text();
                const rows = parseCSV(text);
                const hdr = rows[0].map(h => h.toUpperCase());

                const iDate = hdr.findIndex(h => ['DATE','DATA'].includes(h));
                const iStatus = hdr.findIndex(h => h === 'STATUS');
                const iName = hdr.findIndex(h => ['NAME','IMIƒò','IMIE'].includes(h));
                const iSN = hdr.findIndex(h => h === 'SERIAL NUMBER');
                const iComm = hdr.findIndex(h => h === 'COMMENT');
                const iScrap = hdr.findIndex(h => ['SCRAP TTL','SCRAP_TTL','SCRAP-TTL'].includes(h));

                rows.slice(1).forEach(rw => {
                    const d = normalizeDate(rw[iDate]);
                    const st = (rw[iStatus] || '').toUpperCase();
                    
                    if (d === tgt && (st === 'OK' || st === 'NDF' || st === 'SCRAP_TTL')) {
                        all.push({
                            serial: rw[iSN] || '‚Äì',
                            status: st,
                            name: rw[iName]?.trim() || '‚Äì',
                            comment: rw[iComm] || '‚Äì',
                            station: stationName,
                            scrap: st === 'SCRAP_TTL' ? 1 : 0
                        });
                    }
                });
            } catch (e) {
                console.warn('‚ö†Ô∏è fetch error', url, e);
            }
        }
        return all;
    }
    // **********************************************
    // KONIEC LOGIKI GOOGLE SHEETS
    // **********************************************


    // --- FUNKCJE RENDERUJƒÑCE I UX ---

    // Funkcja do filtrowania detali (nowa)
    window.filterData = function(value) {
        const query = value.trim().toLowerCase();
        document.querySelectorAll('#data-table tbody tr').forEach(row => {
            const serial = row.children[2]?.textContent.toLowerCase() || '';
            const name = row.children[3]?.textContent.toLowerCase() || '';
            row.style.display = serial.includes(query) || name.includes(query) ? '' : 'none';
        });
    }

    function render(data) {
        latestData = data.sort((a,b)=>a.name.localeCompare(b.name));
        document.getElementById('no-data-message').style.display = data.length ? 'none' : 'block';

        // 1. Data Table
        const dtb = document.createElement('tbody');
        latestData.forEach(it => {
            const statusIcon = it.status === 'OK' ? 'fa-check-circle' : (it.status === 'NDF' ? 'fa-exclamation-triangle' : 'fa-times-circle');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="status-${it.status.toLowerCase()}"><i class="fas ${statusIcon}"></i> ${it.status}</td>
                <td>${it.station}</td>
                <td>${it.serial}</td>
                <td>${it.name}</td>
                <td>${it.comment}</td>`;
            dtb.appendChild(tr);
        });
        document.getElementById('data-table').tBodies[0]?.remove();
        document.getElementById('data-table').appendChild(dtb);

        // 2. Summary Table
        const okC={}, ndfC={}, scrC={}, names=new Set();
        latestData.forEach(it=>{
            names.add(it.name);
            okC[it.name]  = (okC[it.name]||0) + (it.status==='OK'?1:0);
            ndfC[it.name] = (ndfC[it.name]||0)+(it.status==='NDF'?1:0);
            scrC[it.name] = (scrC[it.name]||0)+it.scrap;
        });
        const stb = document.createElement('tbody');
        Array.from(names).sort().forEach(n=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:left;">${n}</td>
                <td class="ok">${okC[n]||0}</td>
                <td class="ndf">${ndfC[n]||0}</td>
                <td class="scrap-ttl">${scrC[n]||0}</td>`;
            stb.appendChild(tr);
        });

        // Wiersz SUMA DZIENNA
        const sumOK = Object.values(okC).reduce((a,b)=>a+b,0);
        const sumNDF = Object.values(ndfC).reduce((a,b)=>a+b,0);
        const sumSCR = Object.values(scrC).reduce((a,b)=>a+b,0);
        
        const totalRow = document.createElement('tr');
        totalRow.classList.add('total-row');
        totalRow.innerHTML = `
            <td>SUMA DZIENNA</td>
            <td class="ok">${sumOK}</td>
            <td class="ndf">${sumNDF}</td>
            <td class="scrap-ttl">${sumSCR}</td>`;
        stb.appendChild(totalRow);
        
        document.getElementById('summary-table').tBodies[0]?.remove();
        document.getElementById('summary-table').appendChild(stb);
    }

    window.setDate = function(type) {
        loader.style.display = 'flex';
        
        if (type === 'today') {
            currentDate = new Date();
            setDatePickerValue(currentDate);
            highlightActive('today');
        } else if (type === 'yesterday') {
            currentDate = new Date();
            currentDate.setDate(currentDate.getDate() - 1);
            setDatePickerValue(currentDate);
            highlightActive('yesterday');
        } else if (type === 'custom') {
            const dateValue = datePicker.value;
            if (dateValue) {
                currentDate = new Date(dateValue.replace(/-/g, '/')); 
            }
            highlightActive(null);
        }

        document.getElementById('summary-date').textContent = formatDate(currentDate);

        loadData()
            .then(render)
            .finally(() => {
                loader.style.display = 'none';
            });
    }

    window.manualLoad = function() {
        setDate('custom'); // Dzia≈Ça jako prze≈Çadowanie aktualnie wybranej daty
    }

    window.exportToExcel = function() {
        const ws = XLSX.utils.json_to_sheet(
            latestData.map(d=>({
                STATUS: d.status,
                'SERIAL NUMBER': d.serial,
                NAME: d.name,
                COMMENT: d.comment,
                STATION: d.station
            }))
        );
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'LCDR Data');
        XLSX.writeFile(wb, `LCDR_DATA_${formatDate(currentDate)}.xlsx`);
    }

    window.toggleTheme = function() {
        const body = document.body;
        body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');

        const icon = document.querySelector('#themeToggle i');
        const text = document.querySelector('#themeToggle');
        
        if (isDark) {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
            text.innerHTML = '<i class="fas fa-sun"></i> Jasny Tryb';
        } else {
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
            text.innerHTML = '<i class="fas fa-moon"></i> Ciemny Tryb';
        }
    }

    // --- Inicjalizacja ---
    
    function init() {
        // Ustawienie motywu na podstawie localStorage
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            toggleTheme(); // Wymu≈õ aktualizacjƒô tekstu/ikony przycisku
        }

        // Ustawienie daty na "Dzisiaj" i ≈Çadowanie danych
        setDate('today');
    }
    
    init();

</script>
</body>
</html>
